<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Căutare Prețuri Piese - MOTOLAND</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="fixed top-4 left-4 z-50">
    <a href="../credit/" class="flex items-center gap-2 bg-white hover:bg-gray-100 text-gray-700 font-medium px-4 py-3 rounded-xl shadow-lg border">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      Înapoi
    </a>
  </div>

  <header class="bg-white shadow-sm py-6 text-center">
    <img src="logos/logo.svg" alt="MOTOLAND" class="h-12 mx-auto">
  </header>

  <main class="max-w-3xl mx-auto px-6 py-10">
    <div x-data="searchApp()" class="bg-white rounded-2xl shadow-xl p-8">
      <h1 class="text-4xl font-bold text-center mb-4">Căutare Prețuri Piese</h1>
      <input 
        type="text" 
        x-model="query" 
        @input.debounce.300ms="search"
        placeholder="Scrie codul..."
        class="w-full px-6 py-5 text-xl border-2 border-gray-300 rounded-xl focus:border-blue-600 focus:outline-none"
        autofocus
      >

      <template x-if="results.length">
        <div class="mt-8 space-y-4">
          <template x-for="r in results">
            <div class="bg-gray-50 rounded-xl p-6 border hover:bg-gray-100 transition">
              <div class="flex justify-between items-start">
                <div>
                  <h3 class="text-xl font-bold" x-text="r.name"></h3>
                  <div class="text-sm text-gray-600 mt-1">
                    <span class="font-semibold text-indigo-600" x-text="r.brand"></span>
                    <span class="ml-3" x-text="r.code"></span>
                    <span x-show="r.replaced" class="text-orange-600 font-medium ml-3">
                      → Înlocuit cu: <span x-text="r.replaced"></span>
                    </span>
                  </div>
                </div>
                <div class="text-right">
                  <template x-if="r.brand === 'SUZUKI'">
                    <div class="text-3xl font-bold text-gray-900" x-text="format(r.price) + ' LEI'"></div>
                  </template>
                  <template x-if="r.brand !== 'SUZUKI'">
                    <div>
                      <div class="text-2xl font-bold text-green-600">Stoc: <span x-text="format(r.price)"></span> LEI</div>
                      <div class="text-xl font-bold text-red-600 mt-2">Urgent: <span x-text="format(r.urgent)"></span> LEI</div>
                    </div>
                  </template>
                </div>
              </div>
            </div>
          </template>
        </div>
      </template>

      <div x-show="!query" class="text-center py-20 text-gray-400 text-xl">
        Scrie un cod pentru a vedea prețul
      </div>

      <div x-show="query && !results.length" class="text-center py-20 text-red-600 text-2xl font-bold">
        Cod negăsit
      </div>
    </div>
  </main>

  <script>
    function searchApp() {
      const MULT = 1.35 * 1.40 * 20; // 37.8

      const discounts = {
        SUZUKI: 25, HONDA: 35, YAMAHA: 33, KAWASAKI: 25,
        KTM: 10, HUSQVARNA: 10, PIAGGIO: 25, DUCATI: 5, DEFAULT: 30
      };

      const urgentDisc = {
        HONDA: 20, YAMAHA: 20, KAWASAKI: 20, KTM: 10, HUSQVARNA: 10,
        PIAGGIO: 25, DUCATI: 5, DEFAULT: 15
      };

      const files = [
        'data/suzuki.json','data/honda1.json','data/honda2.json',
        'data/yamaha.json','data/kawasaki.json',
        'data/china1.json','data/china2.json','data/china3.json','data/diverse.json'
      ];

      let all = [];

      // Încărcare simplă și sigură
      Promise.all(files.map(f => fetch(f + '?t=' + Date.now()).then(r => r.ok ? r.json().catch(() => []) : [])))
        .then(arrays => {
          arrays.forEach(data => {
            if (!data) return;
            const list = Array.isArray(data) ? data : Object.values(data);
            list.forEach(item => {
              if (!item.COD || !item.PRE) return;
              const cod = String(item.COD).trim();
              const codnou = item.CODNOU ? String(item.CODNOU).trim() : '';
              const pre = parseFloat(item.PRE);
              if (!pre) return;

              let brand = (item.BRAND || '').toString().trim().toUpperCase().replace(/^\d+-/, '');
              if (brand.includes('HOND')) brand = 'HONDA';
              if (brand.includes('SUZU')) brand = 'SUZUKI';
              if (brand.includes('YAMAH')) brand = 'YAMAHA';
              if (brand.includes('KAWAS')) brand = 'KAWASAKI';

              const base = Math.round(pre * MULT);
              const disc = discounts[brand] ?? discounts.DEFAULT;
              const price = Math.round(base * (1 - disc/100));
              const urgent = brand === 'SUZUKI' ? null : Math.round(base * (1 - (urgentDisc[brand] ?? urgentDisc.DEFAULT)/100));

              all.push({
                name: String(item.DENUMIRE || '').trim(),
                brand: brand,
                code: codnou || cod,
                replaced: codnou && codnou !== cod ? codnou : '',
                price: price,
                urgent: urgent
              });
            });
          });
        });

      return {
        query: '',
        results: [],

        search() {
          if (!this.query) {
            this.results = [];
            return;
          }
          const q = this.query.toUpperCase();
          this.results = all
            .filter(i => i.code.toUpperCase().includes(q))
            .slice(0, 200);
        },

        format(x) {
          return x?.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') || '';
        }
      };
    }
  </script>
</body>
</html>
