<script>
  function app() {
    return {
      query: '',
      selectedBrand: '',
      results: [],
      loading: false,
      cache: {},

      discounts: { SUZUKI:25, HONDA:35, YAMAHA:33, KAWASAKI:25, KTM:10, HUSQVARNA:10, PIAGGIO:25, DUCATI:5, DEFAULT:30 },
      urgentDiscount: { HONDA:20, YAMAHA:20, KAWASAKI:20, KTM:10, HUSQVARNA:10, PIAGGIO:25, DUCATI:5, DEFAULT:15 },

      get brandName() {
        const names = { suzuki:'Suzuki', honda:'Honda', yamaha:'Yamaha', kawasaki:'Kawasaki', china:'China/Diverse', '':'toate fișierele' };
        return names[this.selectedBrand] || 'fișierele';
      },

      async search() {
        if (!this.query.trim()) {
          this.results = [];
          this.loading = false;
          return;
        }

        this.loading = true;
        const q = this.query.trim().toUpperCase();

        // === LISTA COMPLETĂ DE FIȘIERE ===
        const allFiles = [
          'data/suzuki.json',
          'data/honda1.json',
          'data/honda2.json',
          'data/yamaha.json',
          'data/kawasaki.json',
          'data/china1.json',
          'data/china2.json',
          'data/china3.json',
          'data/diverse.json'
        ];

        let filesToSearch = [];

        if (!this.selectedBrand || this.selectedBrand === '') {
          // TOATE brandurile → toate cele 9 fișiere
          filesToSearch = allFiles;
        } else {
          const map = {
            suzuki:   ['data/suzuki.json'],
            honda:    ['data/honda1.json', 'data/honda2.json'],
            yamaha:   ['data/yamaha.json'],
            kawasaki: ['data/kawasaki.json'],
            china:    ['data/china1.json', 'data/china2.json', 'data/china3.json', 'data/diverse.json']
          };
          filesToSearch = map[this.selectedBrand] || allFiles;
        }

        const items = [];

        for (const file of filesToSearch) {
          // Încarcă doar dacă nu e deja în cache
          if (!this.cache[file]) {
            try {
              const res = await fetch(file + '?t=' + Date.now());
              if (!res.ok) {
                console.warn(`404: ${file}`);
                continue;
              }
              let data = await res.json();
              if (!Array.isArray(data)) data = Object.values(data);
              this.cache[file] = data;
              console.log(`Încărcat: ${file} (${data.length} produse)`);
            } catch (e) {
              console.warn(`Eroare la ${file}:`, e);
              continue;
            }
          }

          const data = this.cache[file];

          for (const raw of data) {
            if (!raw.COD || !raw.PRE) continue;

            const cod    = String(raw.COD).trim();
            const codnou = raw.CODNOU ? String(raw.CODNOU).trim() : '';

            if (!cod.toUpperCase().includes(q) && (!codnou || !codnou.toUpperCase().includes(q))) continue;

            let brand = (String(raw.BRAND || '').trim().toUpperCase().replace(/^\d+-/, ''));
            if (brand.includes('HOND'))  brand = 'HONDA';
            if (brand.includes('SUZU'))  brand = 'SUZUKI';
            if (brand.includes('YAMAH')) brand = 'YAMAHA';
            if (brand.includes('KAWAS')) brand = 'KAWASAKI';

            const preEur = parseFloat(raw.PRE);
            if (isNaN(preEur) || preEur <= 0) continue;

            const base = Math.round(preEur * 1.35 * 1.40 * 20);

            const discStoc = this.discounts[brand] ?? this.discounts.DEFAULT;
            const discUrg  = this.urgentDiscount[brand] ?? this.urgentDiscount.DEFAULT;

            const pretStoc   = Math.round(base * (1 - discStoc / 100));
            const pretUrgent = brand === 'SUZUKI' ? null : Math.round(base * (1 - discUrg / 100));

            items.push({
              id: cod + '_' + Date.now() + Math.random(),
              DENUMIRE: String(raw.DENUMIRE || '').trim(),
              brand: brand,
              code: codnou || cod,
              codnou: codnou || null,
              isSuzuki: brand === 'SUZUKI',
              pret: pretStoc,
              pret_stoc: pretStoc,
              pret_urgent: pretUrgent
            });
          }
        }

        this.results = items.slice(0, 100);
        this.loading = false;
      },

      format(x) {
        return x ? x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') : '—';
      }
    }
  }
</script>
