<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Căutare Prețuri Piese - MOTOLAND</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <link rel="icon" href="data:,">
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

  <div class="fixed top-4 left-4 z-50">
    <a href="../credit/" class="flex items-center gap-2 bg-white hover:bg-gray-100 text-gray-700 font-medium px-4 py-3 rounded-xl shadow-lg border border-gray-200">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
      </svg>
      <span class="hidden sm:inline">Înapoi</span>
    </a>
  </div>

  <header class="bg-white shadow-sm border-b py-5 text-center">
    <img src="logos/logo.svg" alt="MOTOLAND" class="h-10 mx-auto">
  </header>

  <main class="flex-1 max-w-2xl mx-auto w-full px-6 py-10">
    <div x-data="priceSearch()">
      <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">
        Căutare Prețuri Piese China & Agro
      </h1>
      <p class="text-center text-gray-600 mb-8 text-sm">
        Scrie codul exact sau parțial
      </p>

      <input type="text" x-model.debounce.500ms="query"
             placeholder="Introdu codul..."
             class="w-full px-5 py-4 text-lg border border-gray-300 rounded-xl focus:border-gray-600 focus:outline-none mb-8"
             autofocus>

      <!-- REZULTATE -->
      <div x-show="results.length > 0" class="bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden">
        <div class="bg-green-50 border-b border-green-200 px-6 py-3 flex items-center gap-2">
          <svg class="w-5 h-5 text-green-600" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
          </svg>
          <span class="font-medium text-green-800">Rezultate găsite: <span x-text="results.length"></span></span>
        </div>
        <ul class="divide-y divide-gray-200">
          <template x-for="item in results" :key="item.id">
            <li class="px-6 py-4 hover:bg-gray-50 flex justify-between items-center">
              <div class="flex items-center gap-3 flex-1">
                <svg class="w-5 h-5 text-green-600 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"/>
                </svg>
                <div class="flex-1">
                  <div class="font-medium text-gray-800" x-text="item.DENUMIRE"></div>
                  <div class="text-sm text-gray-600">
                    <span class="font-semibold text-indigo-600" x-text="item.cleanBrand"></span>
                    <span x-show="item.hasCodNou" class="text-orange-600 font-medium ml-3">
                      → Cod înlocuitor: <span x-text="item.codeToShow"></span>
                    </span>
                    <span x-show="!item.hasCodNou" class="text-gray-500 ml-3" x-text="item.codeToShow"></span>
                  </div>
                </div>
              </div>

              <div class="text-right">
                <div x-show="item.isSuzuki" class="text-xl font-bold text-gray-900">
                  <span x-text="format(item.finalPrice)"></span> LEI
                </div>
                <div x-show="!item.isSuzuki">
                  <div class="text-xl font-bold text-green-700">
                    Stoc: <span x-text="format(item.finalPrice)"></span> LEI
                  </div>
                  <div class="text-lg font-medium text-red-600 mt-1">
                    Urgent: <span x-text="format(item.urgentPrice)"></span> LEI
                  </div>
                </div>
              </div>
            </li>
          </template>
        </ul>
      </div>

      <div x-show="!query" class="text-center text-gray-400 py-12">
        <p>Începe să scrii codul pentru a vedea prețul</p>
      </div>
      <div x-show="query && results.length === 0" class="text-center py-12 text-gray-500">
        <p class="text-lg">Cod negăsit</p>
      </div>
    </div>
  </main>

  <script>
    function priceSearch() {
      return {
        query: '',
        results: [],
        items: [],
        loaded: false,

        // TOATE REDUCERILE EXACT DIN TABELUL TĂU
        discounts: {
          "SUZUKI":     { stoc: 25, urgent: null },
          "HONDA":      { stoc: 35, urgent: 20 },
          "YAMAHA":     { stoc: 33, urgent: 20 },
          "KAWASAKI":   { stoc: 25, urgent: 20 },
          "KTM":        { stoc: 10, urgent: 10 },
          "HUSQVARNA":  { stoc: 10, urgent: 10 },
          "PIAGGIO":    { stoc: 25, urgent: 25 },
          "DUCATI":     { stoc: null, urgent: 5 },
          "DEFAULT":    { stoc: 30, urgent: 15 }
        },

        BASE_MULTIPLIER: 1.35 * 1.40 * 20,  // 37.8

        init() {
          this.loadAllFiles();
          this.$watch('query', () => this.search());
        },

        async loadAllFiles() {
          const files = [
            'data/suzuki.json', 'data/honda1.json', 'data/honda2.json',
            'data/yamaha.json', 'data/kawasaki.json',
            'data/china1.json', 'data/china2.json', 'data/china3.json', 'data/diverse.json'
          ];

          for (const file of files) {
            try {
              const resp = await fetch(file + '?t=' + Date.now());
              if (!resp.ok) continue;
              const data = await resp.json();

              const array = Array.isArray(data) ? data : Object.values(data);

              array.forEach((raw, index) => {
                if (!raw || !raw.COD) return;

                const cod = String(raw.COD || '').trim();
                const codnou = raw.CODNOU ? String(raw.CODNOU).trim() : '';
                const brandRaw = String(raw.BRAND || '').trim();
                const pre = parseFloat(raw.PRE) || 0;

                if (!cod || pre === 0) return;

                // Curățare brand
                const clean = brandRaw.replace(/^\d+-/i, '').trim().toUpperCase();
                const finalBrand = {
                  'HOND': 'HONDA', 'SUZU': 'SUZUKI', 'YAMAH': 'YAMAHA',
                  'KAWAS': 'KAWASAKI', 'HUSQ': 'HUSQVARNA', 'PIAG': 'PIAGGIO',
                  'DUCA': 'DUCATI'
                }[clean] || clean;

                this.items.push({
                  id: cod + '_' + index,
                  COD: cod,
                  CODNOU: codnou,
                  DENUMIRE: String(raw.DENUMIRE || '').trim(),
                  PRE: pre,
                  BRAND: brandRaw,
                  cleanBrand: finalBrand,
                  isSuzuki: finalBrand === 'SUZUKI'
                });
              });
            } catch (e) {
              console.warn('Eroare la încărcarea:', file);
            }
          }

          this.loaded = true;
          console.log('Încărcate', this.items.length, 'produse');
          this.search();
        },

        getPrices(item) {
          const base = item.PRE * this.BASE_MULTIPLIER;
          const disc = this.discounts[item.cleanBrand] || this.discounts.DEFAULT;

          const stoc = disc.stoc !== null ? Math.round(base * (1 - disc.stoc / 100)) : null;
          const urgent = disc.urgent !== null ? Math.round(base * (1 - disc.urgent / 100)) : null;

          return { stoc, urgent };
        },

        displayCode(item) {
          return item.CODNOU || item.COD;
        },

        hasCodNou(item) {
          return item.CODNOU && item.CODNOU !== item.COD;
        },

        search() {
          if (!this.loaded || !this.query.trim()) {
            this.results = [];
            return;
          }

          const q = this.query.trim().toUpperCase();

          let matches = this.items.filter(item =>
            item.COD.toUpperCase().includes(q) ||
            (item.CODNOU && item.CODNOU.toUpperCase().includes(q))
          );

          this.results = matches.map(item => {
            const p = this.getPrices(item);
            return {
              ...item,
              finalPrice: p.stoc,
              urgentPrice: item.isSuzuki ? null : p.urgent,
              codeToShow: this.displayCode(item),
              hasCodNou: this.hasCodNou(item)
            };
          });

          // Elimină duplicate
          const seen = new Set();
          this.results = this.results.filter(r => {
            if (seen.has(r.codeToShow)) return false;
            seen.add(r.codeToShow);
            return true;
          });
        },

        format(p) {
          return p ? p.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.') : '—';
        }
      };
    }
  </script>
</body>
</html>
