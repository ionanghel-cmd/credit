<!DOCTYPE html>
<html lang="ro">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Curs Valutar ProCredit Bank & BNM</title>
  <link rel="stylesheet" href="style.css"/>
  <link rel="icon" href="data:,"/>
</head>
<body>
  <div class="container">
    <h1>Rate de Schimb Valutar</h1>
    <p class="subtitle">ProCredit Bank Moldova â€¢ Persoane fizice prin virament</p>
    
    <div class="update">Se Ã®ncarcÄƒ cursul... <span id="status">ðŸ”„</span></div>

    <table id="rates-table">
      <thead>
        <tr>
          <th>Valuta</th>
          <th>ProCredit CumpÄƒrare</th>
          <th>ProCredit VÃ¢nzare</th>
          <th>BNM (referinÈ›Äƒ)</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="4" style="text-align:center; padding:20px;">Se Ã®ncarcÄƒ...</td></tr>
      </tbody>
    </table>

    <div class="footer">
      Actualizat automat â€¢ 
      <span id="last-update">â€”</span> â€¢ 
      <a href="https://procreditbank.md" target="_blank">procreditbank.md</a> â€¢ 
      <a href="https://bnm.md" target="_blank">bnm.md</a>
    </div>
  </div>

  <script>
    // === Date de backup updatate (2 Dec 2025 - live extrase) ===
    const backupData = {
      date: "2 decembrie 2025",
      rates: {
        EUR: { buy: "19.6600", sell: "19.9100" },
        USD: { buy: "16.9000", sell: "17.1700" }
      }
    };

    // === 1. Fetch live cu proxy stabil (thingproxy - bun pentru 2025) ===
    async function fetchLiveRates() {
      try {
        console.log('ÃŽncerc fetch live cu proxy nou...');
        const proxy = 'https://thingproxy.freeboard.io/fetch/';
        const url = 'https://www.procreditbank.md/ro';

        const response = await fetch(proxy + url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const html = await response.text();
        console.log('HTML primit, lungime:', html.length); // Debug

        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');

        // Selector flexibil: CautÄƒ textul cu "EUR" È™i "USD" Ã®n tabel
        const allText = doc.body.innerText;
        console.log('Text extras:', allText.substring(0, 500)); // Debug parÈ›ial

        const eurMatch = allText.match(/EUR\s*19\.(\d{4})\s*19\.(\d{4})/);
        const usdMatch = allText.match(/USD\s*16\.(\d{4})\s*17\.(\d{4})/);

        if (eurMatch && usdMatch) {
          const rates = {
            EUR: { buy: `19.${eurMatch[1]}`, sell: `19.${eurMatch[2]}` },
            USD: { buy: `16.${usdMatch[1]}`, sell: `17.${usdMatch[2]}` }
          };
          document.getElementById('status').textContent = 'âœ“ Live (actualizat)';
          console.log('Succes live:', rates);
          return { source: 'live', rates, date: new Date().toLocaleDateString('ro-MD') };
        } else {
          // Fallback la querySelector dacÄƒ regex nu prinde
          const rows = doc.querySelectorAll('table tr, .exchange-table tr, .curs-valutar tr');
          const rates = {};
          rows.forEach((row, index) => {
            const text = row.textContent.trim();
            if (text.includes('EUR') && text.match(/19\.\d{4}/g)) {
              const matches = text.match(/19\.(\d{4})/g);
              if (matches && matches.length >= 2) {
                rates.EUR = { buy: matches[0], sell: matches[1] };
              }
            }
            if (text.includes('USD') && text.match(/16\.\d{4}/g)) {
              const matches = text.match(/16\.(\d{4})/g);
              if (matches && matches.length >= 2) {
                rates.USD = { buy: matches[0], sell: matches[1] };
              }
            }
          });
          if (rates.EUR && rates.USD) {
            document.getElementById('status').textContent = 'âœ“ Live (parse)';
            return { source: 'live', rates, date: new Date().toLocaleDateString('ro-MD') };
          }
          throw new Error('Nu s-au gÄƒsit ratele Ã®n HTML');
        }
      } catch (e) {
        console.error('Eroare live:', e.message);
      }
      return null;
    }

    // === 2. Fallback la backup ===
    function useBackup() {
      console.log('Folosim backup updatat');
      document.getElementById('status').textContent = 'âš¡ Backup (live 2 Dec 2025)';
      return { source: 'backup', ...backupData };
    }

    // === 3. AfiÈ™Äƒm tabelul ===
    function displayRates(data) {
      const tbody = document.querySelector('#rates-table tbody');
      document.getElementById('last-update').textContent = data.date;

      // BNM updatat (verificÄƒ pe bnm.md pentru nou)
      const bnmEUR = '19.6801';
      const bnmUSD = '16.9262';

      tbody.innerHTML = `
        <tr>
          <td><span class="flag">ðŸ‡ªðŸ‡º</span> EUR</td>
          <td class="buy">${data.rates.EUR.buy} MDL</td>
          <td class="sell">${data.rates.EUR.sell} MDL</td>
          <td class="bnm">${bnmEUR} MDL</td>
        </tr>
        <tr>
          <td><span class="flag">ðŸ‡ºðŸ‡¸</span> USD</td>
          <td class="buy">${data.rates.USD.buy} MDL</td>
          <td class="sell">${data.rates.USD.sell} MDL</td>
          <td class="bnm">${bnmUSD} MDL</td>
        </tr>
      `;
    }

    // === Pornim ===
    (async () => {
      let data = await fetchLiveRates();
      if (!data) data = useBackup();
      displayRates(data);
    })();
  </script>
</body>
</html>
