    // FIXUL PRINCIPAL – detectăm automat formatul corect
    function redimensioneazaImagine(file, callback) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const MAX = 150;
                let w = img.width, h = img.height;
                if (w > h && w > MAX) { h = Math.round(h * (MAX / w)); w = MAX; }
                else if (h > MAX) { w = Math.round(w * (MAX / h)); h = MAX; }
                canvas.width = w; canvas.height = h;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, w, h);

                // AICI ERA BUG-UL: forțam întotdeauna PNG
                // Acum alegem corect formatul în funcție de fișierul original
                const extensie = file.name.toLowerCase();
                let format = 'image/jpeg';
                let quality = 0.8;
                if (extensie.endsWith('.png')) {
                    format = 'image/png';
                } else if (extensie.endsWith('.webp')) {
                    format = 'image/webp';
                    quality = 0.8;
                }

                const dataUrl = canvas.toDataURL(format, quality);
                console.log(`Imagine procesată ca: ${format.split('/')[1].toUpperCase()}`);
                callback(dataUrl);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    }

    // PDF – acum fără erori de "corrupt PNG"
    function genereazaPDF() {
        if (pozitii.length === 0) return alert('Adaugă cel puțin un produs!');

        try {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');

            // Logo (forțăm PNG pentru compatibilitate maximă)
            doc.addImage('https://www.cfmoto.md/storage/brands/arTDWjWx6mDVTvc-cfmoto-logo-98c.webp', 'WEBP', 15, 10, 60, 24);

            doc.setFontSize(20);
            doc.text('OFERTĂ COMERCIALĂ', 105, 25, { align: 'center' });

            doc.setFontSize(11);
            doc.text(`Client: ${document.getElementById('client').value || '—'}`, 15, 45);
            doc.text(`Valabilitate: ${document.getElementById('dataExpirare').value}`, 15, 52);
            doc.text(`Manager: ${document.getElementById('manager').value}`, 15, 59);
            doc.text(`Referință: ${document.getElementById('ref').value || '—'}`, 15, 66);

            // Tabel simplu + poze adăugate manual (fără didDrawCell)
            let y = 75;
            pozitii.forEach((p, i) => {
                const subtotal = p.cantitate * p.pret;
                // Poza produs
                if (p.imagine) {
                    try {
                        doc.addImage(p.imagine, 15, y, 25, 25); // funcționează cu JPG/PNG/WEBP
                    } catch (e) {
                        console.log('Poză ignorată în PDF (coruptă)', e);
                    }
                }
                // Textul lângă poză
                doc.setFontSize(10);
                doc.text(`${i + 1}. ${p.denumire}`, 45, y + 8);
                doc.text(`Cantitate: ${p.cantitate} × ${p.pret.toFixed(2)} ${p.valuta} = ${subtotal.toFixed(2)} ${p.valuta}`, 45, y + 18);
                y += 35;
            });

            // Total mare
            const totalMDL = pozitii.filter(p => p.valuta === 'MDL').reduce((s, p) => s + p.pret * p.cantitate, 0);
            const totalEUR = pozitii.filter(p => p.valuta === 'EUR').reduce((s, p) => s + p.pret * p.cantitate, 0);
            let totalText = 'TOTAL OFERTĂ: ';
            if (totalMDL) totalText += `${totalMDL.toFixed(2)} MDL`;
            if (totalEUR) totalText += ` | ${totalEUR.toFixed(2)} EUR`;

            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(totalText, 15, y + 10);

            const nume = document.getElementById('ref').value.trim() || 'Oferta_CFMOTO';
            doc.save(`${nume}_${new Date().toISOString().slice(0,10)}.pdf`);

            alert('PDF generat și descărcat cu succes!');
        } catch (err) {
            console.error(err);
            alert('Eroare PDF: ' + err.message);
        }
    }
